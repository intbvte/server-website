<script lang="ts">
	import { backendUrl } from '$lib/data';
	import { minecraftUserDataSchema } from '$lib/schemas';
	import Skin from '$lib/Skin.svelte';
	import Whitelist from '$lib/Whitelist.svelte';
	import type { PageData } from './$types';

	import WhitelistModal from '$lib/WhitelistModal.svelte';
	import { safeFetchWithSchema } from '$lib';
	import Status from '$lib/Status.svelte';

	export let data: PageData;

	let whitelistModal: WhitelistModal;

	let minecraftUsername: string = '';
	// if(data.user && data.user.minecraft_uuid)
	// 	fetch(`${backendUrl}/users/id_to_username/minecraft/${data.user?.minecraft_uuid}`)
	// 		.then(res=>res.json())
	// 		.then(minecraftUserDataSchema.parseAsync)
	// 		.then(user=>minecraftUsername = user.minecraft_username)

	if (data.user && data.user.minecraft_uuid)
		safeFetchWithSchema(
			new Request(`${backendUrl}/users/id_to_username/minecraft/${data.user?.minecraft_uuid}`),
			minecraftUserDataSchema
		).then((data) => {
			if (data.success) minecraftUsername = data.data.minecraft_username;
		});
</script>

<main class="max-w-screen-lg w-full h-screen mx-auto flex items-center justify-center flex relative">
	<div class="grid grid-cols sm:grid-cols-2 gap-3 w-full max-w-sm drop-shadow-xl shadow-black">
		<div class="sm:col-span-2 flex flex-col gap-2">
			<Status ip="m.jar.run" />
			{#if !data.user || !data.user.minecraft_uuid}
				<Whitelist user={data.user} />
			{/if}
		</div>
		<a href="/docs/install" class="mc-button text-white p-2 text-center pixelated"> Modpack Installation </a>
		<a href="/docs/connect" class="mc-button text-white p-2 text-center pixelated"> Connection Guide </a>
		<div
			class="flex justify-between py-1 sm:col-span-2 mc-dark divide-x-2 divide-[#202020] mx-auto"
		>
			<a href="https://modrinth.com/modpack/steam-punk" target="_blank" class="w-full space-y-2 content-center">
				<img src="/ui/modrinth_logo.png" width="48" class="pixelated mx-auto px-2" alt="" />
			</a>
			<a href="https://map.jar.run" target="_blank" class="w-full space-y-2 content-center">
				<img src="/ui/bluemap_logo.png" width="48" class="pixelated mx-auto px-2" alt="" />
			</a>
		</div>
		{#if data.user && data.user.minecraft_uuid}
			<div
				class="sm:absolute mx-auto sm:mx-5 sm:col-span-2 right-full w-32 flex flex-col items-center m-2"
			>
				<span class="bg-black/50 text-white px-2 py-0.5">{minecraftUsername}</span>
				<div class="drop-shadow-md w-full h-48">
					<Skin data={{ uuid: data.user.minecraft_uuid }} />
				</div>
				<input
					type="button"
					class="text-white/50 text-xs hover:underline cursor-pointer"
					on:click={whitelistModal.openModal}
					value="Change"
				/>
			</div>
			<WhitelistModal usernameInput={minecraftUsername} bind:this={whitelistModal} />
		{/if}
	</div>
</main>